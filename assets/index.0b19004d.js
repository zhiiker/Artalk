var t=Object.defineProperty,e=("undefined"!=typeof require&&require,(e,i,s)=>(((e,i,s)=>{i in e?t(e,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[i]=s})(e,"symbol"!=typeof i?i+"":i,s),s));import{l as i,h as s}from"./vendor.8e346cb0.js";!function(){const t=document.createElement("link").relList;if(!(t&&t.supports&&t.supports("modulepreload"))){for(const t of document.querySelectorAll('link[rel="modulepreload"]'))e(t);new MutationObserver((t=>{for(const i of t)if("childList"===i.type)for(const t of i.addedNodes)"LINK"===t.tagName&&"modulepreload"===t.rel&&e(t)})).observe(document,{childList:!0,subtree:!0})}function e(t){if(t.ep)return;t.ep=!0;const e=function(t){const e={};return t.integrity&&(e.integrity=t.integrity),t.referrerpolicy&&(e.referrerPolicy=t.referrerpolicy),"use-credentials"===t.crossorigin?e.credentials="include":"anonymous"===t.crossorigin?e.credentials="omit":e.credentials="same-origin",e}(t);fetch(t.href,e)}}();function n(t=""){const e=document.createElement("div");return e.innerHTML=t.trim(),e.firstElementChild||e}function a(t){const e=RegExp(`[?&]${t}=([^&]*)`).exec(window.location.search);return e&&decodeURIComponent(e[1].replace(/\+/g," "))}function r(t){const e=t.getBoundingClientRect();return{top:e.top+window.scrollY,left:e.left+window.scrollX}}function o(t,e){let i=t.toString();for(;i.length<e;)i=`0${i}`;return i}function l(t){try{const e=t.getTime(),i=(new Date).getTime()-e,s=Math.floor(i/864e5);if(0===s){const t=i%864e5,e=Math.floor(t/36e5);if(0===e){const e=t%36e5,i=Math.floor(e/6e4);if(0===i){const t=e%6e4;return`${Math.round(t/1e3)} 秒前`}return`${i} 分钟前`}return`${e} 小时前`}return s<0?"刚刚":s<8?`${s} 天前`:function(t){const e=o(t.getDate(),2),i=o(t.getMonth()+1,2);return`${o(t.getFullYear(),2)}-${i}-${e}`}(t)}catch(e){return console.error(e)," - "}}let c=null;function d(t,e){if(!c){const t=new i.Renderer,e=t.link;t.link=(i,s,n)=>e.call(t,i,s,n).replace(/^<a /,'<a target="_blank" rel="nofollow" ');const n=i;n.setOptions({renderer:t,highlight:t=>s(t),pedantic:!1,gfm:!0,tables:!0,breaks:!0,sanitize:!0,smartLists:!0,smartypants:!0,xhtml:!1}),c=n}return c(e)}class h{constructor(t){e(this,"data");const i=JSON.parse(window.localStorage.getItem("ArtalkUser")||"{}");this.data={nick:i.nick||"",email:i.email||"",link:i.link||"",token:i.token||"",isAdmin:i.isAdmin||!1}}save(){window.localStorage.setItem("ArtalkUser",JSON.stringify(this.data))}checkHasBasicUserInfo(){return!!this.data.nick&&!!this.data.email}}class p{constructor(t,i){e(this,"cid"),e(this,"rootEl"),e(this,"conf"),e(this,"user"),e(this,"eventList",[]),this.cid=+new Date,this.rootEl=t,this.conf=i,this.user=new h(this.conf)}addEventListener(t,e){this.eventList.push({name:t,listener:e})}removeEventListener(t){this.eventList=this.eventList.filter((e=>e.name!==t))}dispatchEvent(t,e){this.eventList.filter((e=>e.name===t)).map((t=>t.listener)).forEach((t=>t(e)))}}function m(t){t instanceof p&&(t=t.rootEl);let e=t.querySelector(".atk-loading");e||(e=n('\n        <div class="atk-loading" style="display: none;">\n          <div class="atk-loading-spinner">\n          <svg viewBox="25 25 50 50"><circle cx="50" cy="50" r="20" fill="none" stroke-width="2" stroke-miterlimit="10"></circle></svg>\n          </div>\n          </div>'),t.appendChild(e)),e.style.display=""}function u(t){t instanceof p&&(t=t.rootEl);const e=t.querySelector(".atk-loading");e&&(e.style.display="none")}function g(t){const e=window.scrollY,i=e+document.documentElement.clientHeight,s=r(t).top;return s+t.offsetHeight<=i&&s>=e}function k(t,e=!0){if(g(t))return;const i=r(t).top+parseFloat(getComputedStyle(t,null).height.replace("px",""))/2-document.documentElement.clientHeight/2;e?window.scroll({top:i>0?i:0,left:0,behavior:"smooth"}):window.scroll(0,i>0?i:0)}function y(t,e,i){const s=n(`<div class="atk-notify atk-fade-in" style="background-color: ${{s:"#57d59f",e:"#ff6f6c",w:"#ffc721",i:"#2ebcfc"}[i]}"><span class="atk-notify-content"></span></div>`);s.querySelector(".atk-notify-content").innerHTML=function(t){const e=document.createElement("div");return e.innerText=t,e.innerHTML}(e).replace("\n","<br/>"),t.appendChild(s);const a=()=>{s.classList.add("atk-fade-out"),setTimeout((()=>{s.remove()}),200)};let r;r=window.setTimeout((()=>{a()}),3e3),s.addEventListener("click",(()=>{a(),window.clearTimeout(r)}))}function v(t,e){!function(t,e,i="in"){t.classList.add(`atk-fade-${i}`);const s=()=>{t.classList.remove(`atk-fade-${i}`),t.removeEventListener("animationend",s),e&&e()};t.addEventListener("animationend",s)}(t,e,"in")}function f(t,e){t instanceof p&&(t=t.rootEl);let i=t.querySelector(".atk-error-layer");if(null===e)return void(null!==i&&i.remove());i||(i=n('<div class="atk-error-layer"><span class="atk-error-title">Artalk Error</span><span class="atk-error-text"></span></div>'),t.appendChild(i));const s=i.querySelector(".atk-error-text");s.innerHTML="",null!==e&&(e instanceof HTMLElement?s.appendChild(e):s.innerText=e)}class E{constructor(t){e(this,"el"),e(this,"ctx"),e(this,"conf"),this.ctx=t,this.conf=t.conf}}const x="atk-dark-mode";function w(t){let e=document.querySelector(`.atk-layer-wrap#ctx-${t.cid}`);e||(e=n(`<div class="atk-layer-wrap" id="ctx-${t.cid}" style="display: none;"><div class="atk-layer-mask"></div></div>`),document.body.appendChild(e));const i=e.querySelector(".atk-layer-mask");return e&&(t.conf.darkMode?e.classList.add(x):e.classList.remove(x)),{wrapEl:e,maskEl:i}}function b(t,e,i){return new S(t,e,i)}const L=class extends E{constructor(t,i,s){super(t),e(this,"name"),e(this,"wrapEl"),e(this,"maskEl"),e(this,"maskClickHideEnable",!0),this.name=i;const{wrapEl:a,maskEl:r}=w(t);this.wrapEl=a,this.maskEl=r,this.el=this.wrapEl.querySelector(`[data-layer-name="${i}"].atk-layer-item`),null===this.el&&(s?this.el=s:(this.el=n(),this.el.classList.add("atk-layer-item"))),this.el.setAttribute("data-layer-name",i),this.el.style.display="none",this.wrapEl.append(this.el)}getName(){return this.name}getWrapEl(){return this.wrapEl}getEl(){return this.el}show(){L.hideTimeoutList.forEach((t=>{clearTimeout(t)})),L.hideTimeoutList=[],this.wrapEl.style.display="block",this.maskEl.style.display="block",this.maskEl.classList.add("atk-fade-in"),this.el.style.display="",this.maskEl.onclick=()=>{this.maskClickHideEnable&&this.hide()},document.body.style.overflow="hidden"}hide(){L.hideTimeoutList.push(window.setTimeout((()=>{this.wrapEl.style.display="none",document.body.style.overflow=""}),450)),this.wrapEl.classList.add("atk-fade-out"),L.hideTimeoutList.push(window.setTimeout((()=>{this.wrapEl.style.display="none",this.wrapEl.classList.remove("atk-fade-out")}),200)),this.el.style.display="none"}setMaskClickHide(t){this.maskClickHideEnable=t}disposeNow(){document.body.style.overflow="",this.el.remove(),this.checkCleanLayer()}dispose(){this.hide(),this.el.remove(),this.checkCleanLayer()}checkCleanLayer(){0===this.getWrapEl().querySelectorAll(".atk-layer-item").length&&(this.wrapEl.style.display="none")}};let S=L;e(S,"hideTimeoutList",[]);class T{constructor(t){e(this,"ctx"),e(this,"serverURL"),this.ctx=t,this.serverURL=t.conf.server}get(t,e,i){var s;const n={page_key:this.ctx.conf.pageKey,limit:(null==(s=this.ctx.conf.readMore)?void 0:s.pageSize)||15,offset:t};return e&&(n.type=e),this.ctx.user.checkHasBasicUserInfo()&&(n.name=this.ctx.user.data.nick,n.email=this.ctx.user.data.email),this.ctx.conf.site&&(n.site_name=this.ctx.conf.site),i&&i(n),C(this.ctx,`${this.serverURL}/get`,{method:"POST",body:$(n)}).then((t=>t.data))}add(t){const e={name:t.nick,email:t.email,link:t.link,content:t.content,rid:t.rid,page_key:this.ctx.conf.pageKey,page_url:this.ctx.conf.pageUrl||"",page_title:this.ctx.conf.pageTitle||""};return this.ctx.conf.site&&(e.site_name=this.ctx.conf.site),C(this.ctx,`${this.serverURL}/add`,{method:"POST",body:$(e)}).then((t=>t.data.comment))}login(t,e,i){const s={name:t,email:e,password:i};return this.ctx.conf.site&&(s.site_name=this.ctx.conf.site),C(this.ctx,`${this.serverURL}/login`,{method:"POST",body:$(s)}).then((t=>t.data.token))}userGet(t,e){const i=new AbortController,{signal:s}=i,n={name:t,email:e};this.ctx.conf.site&&(n.site_name=this.ctx.conf.site);return{req:C(this.ctx,`${this.serverURL}/user-get`,{method:"POST",body:$(n),signal:s}).then((t=>({user:t.data.user,is_login:t.data.is_login,unread:t.data.unread||[],unread_count:t.data.unread_count||0}))),abort:()=>{i.abort()}}}vote(t,e){const i={target_id:t,type:e};return this.ctx.user.checkHasBasicUserInfo()&&(i.name=this.ctx.user.data.nick,i.email=this.ctx.user.data.email),this.ctx.conf.site&&(i.site_name=this.ctx.conf.site),C(this.ctx,`${this.serverURL}/vote`,{method:"POST",body:$(i)}).then((t=>{var e;return(null==(e=t.data)?void 0:e.vote_num)||0}))}markRead(t,e=!1){const i={notify_key:t};return e&&(delete i.notify_key,i.read_all=!0,i.name=this.ctx.user.data.nick,i.email=this.ctx.user.data.email),this.ctx.conf.site&&(i.site_name=this.ctx.conf.site),C(this.ctx,`${this.serverURL}/mark-read`,{method:"POST",body:$(i)}).then((t=>t.success))}captchaGet(){return C(this.ctx,`${this.serverURL}/captcha/refresh`,{method:"GET"}).then((t=>t.success&&t.data.img_data?t.data.img_data:""))}captchaCheck(t){return C(this.ctx,`${this.serverURL}/captcha/check?${new URLSearchParams({value:t})}`,{method:"GET"}).then((t=>!t.success&&t.data.img_data?t.data.img_data:""))}commentEdit(t){const e={...t};return void 0!==e.is_collapsed&&(e.is_collapsed=e.is_collapsed?"1":"0"),void 0!==e.is_pending&&(e.is_pending=e.is_pending?"1":"0"),this.ctx.conf.site&&(e.site_name=this.ctx.conf.site),C(this.ctx,`${this.serverURL}/admin/comment-edit`,{method:"POST",body:$(e)}).then((t=>t.data.comment))}pageEdit(t){const e={id:t.id,key:t.key,title:t.title,admin_only:t.admin_only?"1":"0"};return this.ctx.conf.site&&(e.site_name=this.ctx.conf.site),C(this.ctx,`${this.serverURL}/admin/page-edit`,{method:"POST",body:$(e)}).then((t=>t.data.page))}pageFetch(t){const e={id:t};return C(this.ctx,`${this.serverURL}/admin/page-fetch`,{method:"POST",body:$(e)}).then((t=>t.data.page))}siteGet(){return C(this.ctx,`${this.serverURL}/admin/site-get`,{method:"POST",body:$({})}).then((t=>t.data.sites))}pageGet(t){const e={site_name:t||""};return C(this.ctx,`${this.serverURL}/admin/page-get`,{method:"POST",body:$(e)}).then((t=>t.data.pages))}pageDel(t,e){const i={key:String(t),site_name:e||""};return C(this.ctx,`${this.serverURL}/admin/page-del`,{method:"POST",body:$(i)}).then((t=>t.success))}siteDel(t,e=!1){const i={id:t,del_content:e?"1":"0"};return C(this.ctx,`${this.serverURL}/admin/site-del`,{method:"POST",body:$(i)}).then((t=>t.success))}siteAdd(t,e){const i={name:t,urls:e};return C(this.ctx,`${this.serverURL}/admin/site-add`,{method:"POST",body:$(i)}).then((t=>t.site))}siteEdit(t,e){const i={id:t,name:e.name,urls:e.urls};return C(this.ctx,`${this.serverURL}/admin/site-edit`,{method:"POST",body:$(i)}).then((t=>t.site))}commentDel(t,e){const i={id:String(t),site_name:e||""};return C(this.ctx,`${this.serverURL}/admin/comment-del`,{method:"POST",body:$(i)}).then((t=>t.success))}importer(t,e,i){const s={data:t,type:e,site_name:i||""};return C(this.ctx,`${this.serverURL}/admin/importer`,{method:"POST",body:$(s)}).then((t=>t.success))}}function C(t,e,i){if(t.user.data.token){const e=new Headers;e.set("Authorization",`Bearer ${t.user.data.token}`),i.headers=e}return(s=15e3,n=fetch(e,i),new Promise(((t,e)=>{const i=setTimeout((()=>{e(new Error("promise timeout"))}),s);n.then((e=>{clearTimeout(i),t(e)}),(t=>{clearTimeout(i),e(t)}))}))).then((async s=>{let n=await s.json();const a=(s,n)=>{C(t,e,i).then((t=>{s(t)})).catch((t=>{n(t)}))};if(n.data&&n.data.need_captcha?n=await new Promise(((e,i)=>{t.dispatchEvent("checker-captcha",{imgData:n.data.img_data,onSuccess:()=>{a(e,i)},onCancel:()=>{i(n)}})})):(n.data&&n.data.need_login||401===s.status)&&(n=await new Promise(((e,i)=>{t.dispatchEvent("checker-admin",{onSuccess:()=>{a(e,i)},onCancel:()=>{i(n)}})}))),n.success)return n;throw n}));var s,n}function $(t){const e=new FormData;return Object.keys(t).forEach((i=>e.append(i,String(t[i])))),e}const M={request:(t,e)=>{const i={name:t.user.data.nick,email:t.user.data.email,password:e};return new T(t.ctx).login(i.name,i.email,i.password)},body:()=>n("<span>敲入密码来验证管理员身份：</span>"),onSuccess:(t,e,i,s)=>{t.user.data.isAdmin=!0,t.user.data.token=e,t.user.save(),t.ctx.dispatchEvent("user-changed"),t.ctx.dispatchEvent("list-reload")},onError:(t,e,i,s)=>{}},O={request:(t,e)=>new T(t.ctx).captchaCheck(e),body:t=>{const e=n(`<span><img class="atk-captcha-img" src="${t.submitCaptchaImgData||""}" alt="验证码">敲入验证码继续：</span>`);return e.querySelector(".atk-captcha-img").onclick=()=>{const i=e.querySelector(".atk-captcha-img");new T(t.ctx).captchaGet().then((t=>{i.setAttribute("src",t)})).catch((t=>{console.error("验证码获取失败 ",t)}))},e},onSuccess:(t,e,i,s,n)=>{t.submitCaptchaVal=s},onError:(t,e,i,s)=>{s.querySelector(".atk-captcha-img").click()}};class q{constructor(t){e(this,"ctx"),e(this,"user"),e(this,"submitCaptchaVal"),e(this,"submitCaptchaImgData"),this.ctx=t,this.user=t.user,this.ctx.addEventListener("checker-captcha",(t=>{t.imgData&&(this.submitCaptchaImgData=t.imgData),this.check("captcha",t)})),this.ctx.addEventListener("checker-admin",(t=>{this.check("admin",t)}))}check(t,e){const i={admin:M,captcha:O}[t],s=b(this.ctx,`checker-${(new Date).getTime()}`);s.setMaskClickHide(!1),s.show();const a=n();a.appendChild(i.body(this));const r=n(`<input id="check" type="${"admin"===t?"password":"text"}" required placeholder="">`);let o;a.appendChild(r),setTimeout((()=>{r.focus()}),80),r.onkeyup=t=>{"Enter"!==t.key&&13!==t.keyCode||(t.preventDefault(),s.getEl().querySelector('button[data-action="confirm"]').click())};const l=function(t,e,i){const s=n('<div class="atk-layer-dialog-wrap">\n      <div class="atk-layer-dialog">\n      <div class="atk-layer-dialog-content"></div>\n      <div class="atk-layer-dialog-action">\n      </div>'),a=s.querySelector(".atk-layer-dialog-action"),r=t=>e=>{const i=t(e.currentTarget);void 0!==i&&!0!==i||s.remove()};if("function"==typeof e){const t=n('<button data-action="confirm">确定</button>');t.onclick=r(e),a.appendChild(t)}if("function"==typeof i){const t=n('<button data-action="cancel">取消</button>');t.onclick=r(i),a.appendChild(t)}return s.querySelector(".atk-layer-dialog-content").appendChild(t),s}(a,(t=>{const n=r.value.trim();o||(o=t.innerText);const c=()=>{t.innerText=o||"",t.classList.remove("error")};return t.innerText="加载中...",i.request(this,n).then((t=>{s.disposeNow(),i.onSuccess&&i.onSuccess(this,t,n,a),e.onSuccess&&e.onSuccess(n,l)})).catch((e=>{var s;s=String(e.msg||String(e)),t.innerText=s,t.classList.add("error"),i.onError&&i.onError(this,e,n,a);const o=setTimeout((()=>{c()}),3e3);r.onfocus=()=>{c(),clearTimeout(o)}})),!1}),(()=>(s.disposeNow(),e.onCancel&&e.onCancel(),!1)));s.getEl().append(l),e.onMount&&e.onMount(l)}}class A{constructor(t){e(this,"editor"),e(this,"ctx"),e(this,"el"),this.editor=t,this.ctx=t.ctx}}class _ extends A{constructor(t){super(t),e(this,"el"),e(this,"emoticons"),e(this,"listWrapEl"),e(this,"typesEl"),this.editor=t,this.emoticons=this.ctx.conf.emoticons,this.initEl()}initEl(){this.el=n('<div class="atk-editor-plug-emoticons"></div>'),this.listWrapEl=n('<div class="atk-emoticons-list-wrap"></div>'),this.el.append(this.listWrapEl),Object.entries(this.emoticons).forEach((([t,e])=>{const i=n('<div class="atk-emoticons-list" style="display: none;"></div>');this.listWrapEl.append(i),i.setAttribute("data-key",t),i.setAttribute("data-input-type",e.inputType),Object.entries(e.container).forEach((([t,s])=>{const a=n('<span class="atk-emoticons-item"></span>');if(i.append(a),a.setAttribute("title",t),a.setAttribute("data-content",s),"image"===e.inputType){const e=document.createElement("img");e.src=s,e.alt=t,a.append(e)}else a.innerText=s}))})),this.typesEl=n('<div class="atk-emoticons-types"></div>'),this.el.append(this.typesEl),Object.entries(this.emoticons).forEach((([t,e])=>{const i=n("<span />");this.typesEl.append(i),i.setAttribute("data-key",t),i.innerText=t})),this.typesEl.querySelectorAll("span").forEach((t=>{t.addEventListener("click",(t=>{const e=t.currentTarget.getAttribute("data-key");e&&this.openType(e)}))})),Object.keys(this.emoticons).length>0&&this.openType(Object.keys(this.emoticons)[0]),this.listWrapEl.querySelectorAll(".atk-emoticons-item").forEach((t=>{t.onclick=t=>{const e=t.currentTarget,i=e.closest(".atk-emoticons-list").getAttribute("data-input-type"),s=e.getAttribute("title"),n=e.getAttribute("data-content");"image"===i?this.editor.insertContent(`:[${s}]`):this.editor.insertContent(n||"")}}))}openType(t){var e;Array.from(this.listWrapEl.children).forEach((e=>{const i=e;i.getAttribute("data-key")!==t?i.style.display="none":i.style.display=""})),this.typesEl.querySelectorAll("span.active").forEach((t=>t.classList.remove("active"))),null==(e=this.typesEl.querySelector(`span[data-key="${t}"]`))||e.classList.add("active"),this.changeListHeight()}getName(){return"emoticons"}getBtnHtml(){return"表情"}getEl(){return this.el}changeListHeight(){}onShow(){setTimeout((()=>{this.changeListHeight()}),30)}onHide(){this.el.parentElement.style.height=""}transEmoticonImageText(t){return Object.entries(this.emoticons).forEach((([e,i])=>{"image"===i.inputType&&Object.entries(i.container).forEach((([e,i])=>{t=t.split(`:[${e}]`).join(`![${e}](${i}) `)}))})),t}}class B extends A{constructor(t){super(t),e(this,"el"),e(this,"binded",!1),this.initEl()}initEl(){this.el=n('<div class="atk-editor-plug-preview"></div>'),this.binded=!1}getName(){return"preview"}getBtnHtml(){return'预览 <i title="Markdown is supported"><svg class="markdown" viewBox="0 0 16 16" version="1.1" width="16" height="16" aria-hidden="true"><path fill-rule="evenodd" d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z"></path></svg></i>'}getEl(){return this.el}onShow(){if(this.updateContent(),!this.binded){const t=()=>{this.updateContent()};this.editor.textareaEl.addEventListener("input",t),this.editor.textareaEl.addEventListener("change",t),this.binded=!0}}onHide(){}updateContent(){"none"!==this.el.style.display&&(this.el.innerHTML=this.editor.getContentMarked())}}class U extends E{constructor(t){super(t),e(this,"LOADABLE_PLUG_LIST",[_,B]),e(this,"plugList",{}),e(this,"el"),e(this,"headerEl"),e(this,"textareaWrapEl"),e(this,"textareaEl"),e(this,"closeCommentEl"),e(this,"plugWrapEl"),e(this,"bottomEl"),e(this,"bottomPartLeftEl"),e(this,"plugSwitcherWrapEl"),e(this,"bottomPartRightEl"),e(this,"submitBtn"),e(this,"notifyWrapEl"),e(this,"replyComment",null),e(this,"sendReplyEl",null),e(this,"queryUserInfo",{timeout:null,abortFunc:null}),e(this,"openedPlugName",null),this.el=n('<div class="atk-editor">\n  <div class="atk-editor-header">\n    <input name="nick" placeholder="昵称" class="atk-nick" type="text" required="required">\n    <input name="email" placeholder="邮箱" class="atk-email" type="email" required="required">\n    <input name="link" placeholder="网址 (https://)" class="atk-link" type="url">\n  </div>\n  <div class="atk-editor-textarea-wrap">\n    <div class="atk-close-comment" style="display: none;"><span>仅管理员可评论</span></div>\n    <textarea id="atk-editor-textarea" class="atk-editor-textarea" placeholder=""></textarea>\n  </div>\n  <div class="atk-editor-plug-wrap" style="display: none;"></div>\n  <div class="atk-editor-bottom">\n    <div class="atk-editor-bottom-part atk-left atk-editor-plug-switcher-wrap"></div>\n    <div class="atk-editor-bottom-part atk-right">\n      <button type="button" class="atk-send-btn"></button>\n    </div>\n  </div>\n  <div class="atk-editor-notify-wrap"></div>\n</div>\n'),this.headerEl=this.el.querySelector(".atk-editor-header"),this.textareaWrapEl=this.el.querySelector(".atk-editor-textarea-wrap"),this.textareaEl=this.el.querySelector(".atk-editor-textarea"),this.closeCommentEl=this.el.querySelector(".atk-close-comment"),this.plugWrapEl=this.el.querySelector(".atk-editor-plug-wrap"),this.bottomEl=this.el.querySelector(".atk-editor-bottom"),this.bottomPartLeftEl=this.el.querySelector(".atk-editor-bottom-part.atk-left"),this.plugSwitcherWrapEl=this.el.querySelector(".atk-editor-plug-switcher-wrap"),this.bottomPartRightEl=this.el.querySelector(".atk-editor-bottom-part.atk-right"),this.submitBtn=this.el.querySelector(".atk-send-btn"),this.notifyWrapEl=this.el.querySelector(".atk-editor-notify-wrap"),this.initLocalStorage(),this.initHeader(),this.initTextarea(),this.initEditorPlug(),this.initBottomPart(),this.ctx.addEventListener("editor-open-comment",(()=>this.openComment())),this.ctx.addEventListener("editor-close-comment",(()=>this.closeComment())),this.ctx.addEventListener("editor-reply",(t=>this.setReply(t))),this.ctx.addEventListener("editor-show-loading",(()=>m(this.el))),this.ctx.addEventListener("editor-hide-loading",(()=>u(this.el))),this.ctx.addEventListener("editor-notify",(t=>this.showNotify(t.msg,t.type)))}get user(){return this.ctx.user}initLocalStorage(){const t=window.localStorage.getItem("ArtalkContent")||"";""!==t.trim()&&(this.showNotify("已自动恢复","i"),this.setContent(t)),this.textareaEl.addEventListener("input",(()=>{this.saveContent()}))}initHeader(){Object.keys(this.user.data).forEach((t=>{const e=this.getInputEl(t);e&&e instanceof HTMLInputElement&&(e.value=this.user.data[t]||"",e.addEventListener("input",(()=>this.onHeaderInputChanged(t,e))))}))}getInputEl(t){return this.headerEl.querySelector(`[name="${t}"]`)}onHeaderInputChanged(t,e){this.user.data[t]=e.value.trim(),"nick"!==t&&"email"!==t||(this.user.data.token="",this.user.data.isAdmin=!1,null!==this.queryUserInfo.timeout&&window.clearTimeout(this.queryUserInfo.timeout),null!==this.queryUserInfo.abortFunc&&this.queryUserInfo.abortFunc(),this.queryUserInfo.timeout=window.setTimeout((()=>{this.queryUserInfo.timeout=null;const{req:t,abort:e}=new T(this.ctx).userGet(this.user.data.nick,this.user.data.email);this.queryUserInfo.abortFunc=e,t.then((t=>{t.is_login||(this.user.data.token="",this.user.data.isAdmin=!1),this.ctx.dispatchEvent("unread-update",{notifies:t.unread}),this.user.checkHasBasicUserInfo()&&!t.is_login&&t.user&&t.user.is_admin&&this.showLoginDialog(),t.user&&t.user.link&&(this.user.data.link=t.user.link,this.getInputEl("link").value=t.user.link)})).finally((()=>{this.queryUserInfo.abortFunc=null}))}),400)),this.saveUser()}showLoginDialog(){this.ctx.dispatchEvent("checker-admin",{onSuccess:()=>{}})}saveUser(){this.user.save(),this.ctx.dispatchEvent("user-changed")}saveContent(){window.localStorage.setItem("ArtalkContent",this.getContentOriginal().trim())}initTextarea(){this.textareaEl.placeholder=this.ctx.conf.placeholder||"",this.textareaEl.addEventListener("keydown",(t=>{9===(t.keyCode||t.which)&&(t.preventDefault(),this.insertContent("\t"))})),this.textareaEl.addEventListener("input",(t=>{this.adjustTextareaHeight()}))}adjustTextareaHeight(){const t=this.textareaEl.offsetHeight-this.textareaEl.clientHeight;this.textareaEl.style.height="0px",this.textareaEl.style.height=`${this.textareaEl.scrollHeight+t}px`}initEditorPlug(){this.plugList={},this.plugWrapEl.innerHTML="",this.plugWrapEl.style.display="none",this.openedPlugName=null,this.plugSwitcherWrapEl.innerHTML="",this.LOADABLE_PLUG_LIST.forEach((t=>{const e=new t(this);this.plugList[e.getName()]=e;const i=n(`<span class="atk-editor-action atk-editor-plug-switcher">${e.getBtnHtml()}</span>`);this.plugSwitcherWrapEl.appendChild(i),i.addEventListener("click",(()=>{if(this.plugSwitcherWrapEl.querySelectorAll(".active").forEach((t=>t.classList.remove("active"))),e.getName()===this.openedPlugName)return e.onHide(),this.plugWrapEl.style.display="none",void(this.openedPlugName=null);if(null===this.plugWrapEl.querySelector(`[data-plug-name="${e.getName()}"]`)){const t=e.getEl();t.setAttribute("data-plug-name",e.getName()),t.style.display="none",this.plugWrapEl.appendChild(t)}Array.from(this.plugWrapEl.children).forEach((t=>{const i=t.getAttribute("data-plug-name");i===e.getName()?(t.style.display="",this.plugList[i].onShow()):(t.style.display="none",this.plugList[i].onHide())})),this.plugWrapEl.style.display="",this.openedPlugName=e.getName(),i.classList.add("active")}))}))}closePlug(){this.plugWrapEl.innerHTML="",this.plugWrapEl.style.display="none",this.openedPlugName=null}insertContent(t){if(document.selection)this.textareaEl.focus(),document.selection.createRange().text=t,this.textareaEl.focus();else if(this.textareaEl.selectionStart||0===this.textareaEl.selectionStart){const e=this.textareaEl.selectionStart,i=this.textareaEl.selectionEnd,s=this.textareaEl.scrollTop;this.setContent(this.textareaEl.value.substring(0,e)+t+this.textareaEl.value.substring(i,this.textareaEl.value.length)),this.textareaEl.focus(),this.textareaEl.selectionStart=e+t.length,this.textareaEl.selectionEnd=e+t.length,this.textareaEl.scrollTop=s}else this.textareaEl.focus(),this.textareaEl.value+=t}setContent(t){this.textareaEl.value=t,this.saveContent(),this.plugList&&this.plugList.preview&&this.plugList.preview.updateContent(),this.adjustTextareaHeight()}clearEditor(){this.setContent(""),this.cancelReply()}getContent(){let t=this.getContentOriginal();if(this.plugList&&this.plugList.emoticons){t=this.plugList.emoticons.transEmoticonImageText(t)}return t}getContentOriginal(){return this.textareaEl.value||""}getContentMarked(){return d(this.ctx,this.getContent())}initBottomPart(){this.initReply(),this.initSubmit()}initReply(){this.replyComment=null,this.sendReplyEl=null}setReply(t){null!==this.replyComment&&this.cancelReply(),null===this.sendReplyEl&&(this.sendReplyEl=n('<div class="atk-send-reply-wrap"><div class="atk-send-reply">回复 <span class="atk-text"></span><span class="atk-cancel" title="取消 AT">×</span></div></div>'),this.sendReplyEl.querySelector(".atk-text").innerText=`@${t.nick}`,this.sendReplyEl.addEventListener("click",(()=>{this.cancelReply()})),this.textareaWrapEl.prepend(this.sendReplyEl)),this.replyComment=t,k(this.el),this.textareaEl.focus()}cancelReply(){null!==this.sendReplyEl&&(this.sendReplyEl.remove(),this.sendReplyEl=null),this.replyComment=null}initSubmit(){this.submitBtn.innerText=this.ctx.conf.sendBtn||"Send",this.submitBtn.addEventListener("click",(t=>{t.currentTarget,this.submit()}))}async submit(){if(""!==this.getContent().trim()){m(this.el);try{const t=await new T(this.ctx).add({content:this.getContent(),nick:this.user.data.nick,email:this.user.data.email,link:this.user.data.link,rid:null===this.replyComment?0:this.replyComment.id});this.ctx.dispatchEvent("list-insert",t),this.clearEditor()}catch(t){this.showNotify(`评论失败，${t.msg||String(t)}`,"e")}finally{u(this.el)}}else this.textareaEl.focus()}showNotify(t,e){y(this.notifyWrapEl,t,e)}closeComment(){this.closeCommentEl.style.display="",this.user.data.isAdmin?(this.textareaEl.style.display="",this.bottomEl.style.display=""):(this.textareaEl.style.display="none",this.closePlug(),this.bottomEl.style.display="none")}openComment(){this.closeCommentEl.style.display="none",this.textareaEl.style.display="",this.bottomEl.style.display=""}}var P=window||{},H=navigator||{};function R(t){var e=t||H.userAgent,i=this,s={Trident:e.indexOf("Trident")>-1||e.indexOf("NET CLR")>-1,Presto:e.indexOf("Presto")>-1,WebKit:e.indexOf("AppleWebKit")>-1,Gecko:e.indexOf("Gecko/")>-1,Safari:e.indexOf("Safari")>-1,Chrome:e.indexOf("Chrome")>-1||e.indexOf("CriOS")>-1,IE:e.indexOf("MSIE")>-1||e.indexOf("Trident")>-1,Edge:e.indexOf("Edge")>-1,Firefox:e.indexOf("Firefox")>-1||e.indexOf("FxiOS")>-1,"Firefox Focus":e.indexOf("Focus")>-1,Chromium:e.indexOf("Chromium")>-1,Opera:e.indexOf("Opera")>-1||e.indexOf("OPR")>-1,Vivaldi:e.indexOf("Vivaldi")>-1,Yandex:e.indexOf("YaBrowser")>-1,Kindle:e.indexOf("Kindle")>-1||e.indexOf("Silk/")>-1,360:e.indexOf("360EE")>-1||e.indexOf("360SE")>-1,UC:e.indexOf("UC")>-1||e.indexOf(" UBrowser")>-1,QQBrowser:e.indexOf("QQBrowser")>-1,QQ:e.indexOf("QQ/")>-1,Baidu:e.indexOf("Baidu")>-1||e.indexOf("BIDUBrowser")>-1,Maxthon:e.indexOf("Maxthon")>-1,Sogou:e.indexOf("MetaSr")>-1||e.indexOf("Sogou")>-1,LBBROWSER:e.indexOf("LBBROWSER")>-1,"2345Explorer":e.indexOf("2345Explorer")>-1,TheWorld:e.indexOf("TheWorld")>-1,XiaoMi:e.indexOf("MiuiBrowser")>-1,Quark:e.indexOf("Quark")>-1,Qiyu:e.indexOf("Qiyu")>-1,Wechat:e.indexOf("MicroMessenger")>-1,Taobao:e.indexOf("AliApp(TB")>-1,Alipay:e.indexOf("AliApp(AP")>-1,Weibo:e.indexOf("Weibo")>-1,Douban:e.indexOf("com.douban.frodo")>-1,Suning:e.indexOf("SNEBUY-APP")>-1,iQiYi:e.indexOf("IqiyiApp")>-1,Windows:e.indexOf("Windows")>-1,Linux:e.indexOf("Linux")>-1||e.indexOf("X11")>-1,"Mac OS":e.indexOf("Macintosh")>-1,Android:e.indexOf("Android")>-1||e.indexOf("Adr")>-1,Ubuntu:e.indexOf("Ubuntu")>-1,FreeBSD:e.indexOf("FreeBSD")>-1,Debian:e.indexOf("Debian")>-1,"Windows Phone":e.indexOf("IEMobile")>-1||e.indexOf("Windows Phone")>-1,BlackBerry:e.indexOf("BlackBerry")>-1||e.indexOf("RIM")>-1,MeeGo:e.indexOf("MeeGo")>-1,Symbian:e.indexOf("Symbian")>-1,iOS:e.indexOf("like Mac OS X")>-1,"Chrome OS":e.indexOf("CrOS")>-1,WebOS:e.indexOf("hpwOS")>-1,Mobile:e.indexOf("Mobi")>-1||e.indexOf("iPh")>-1||e.indexOf("480")>-1,Tablet:e.indexOf("Tablet")>-1||e.indexOf("Pad")>-1||e.indexOf("Nexus 7")>-1};s.Mobile?s.Mobile=!(e.indexOf("iPad")>-1):P.showModalDialog&&P.chrome&&(s[360]=!0);var n,a={engine:["WebKit","Trident","Gecko","Presto"],browser:["Safari","Chrome","Edge","IE","Firefox","Firefox Focus","Chromium","Opera","Vivaldi","Yandex","Kindle","360","UC","QQBrowser","QQ","Baidu","Maxthon","Sogou","LBBROWSER","2345Explorer","TheWorld","XiaoMi","Quark","Qiyu","Wechat","Taobao","Alipay","Weibo","Douban","Suning","iQiYi"],os:["Windows","Linux","Mac OS","Android","Ubuntu","FreeBSD","Debian","iOS","Windows Phone","BlackBerry","MeeGo","Symbian","Chrome OS","WebOS"],device:["Mobile","Tablet"]};for(var r in i.device="PC",i.language=((n=(H.browserLanguage||H.language).split("-"))[1]&&(n[1]=n[1].toUpperCase()),n.join("_")),a)for(var o=0;o<a[r].length;o++){var l=a[r][o];s[l]&&(i[r]=l)}var c={Windows:function(){var t=e.replace(/^.*Windows NT ([\d.]+);.*$/,"$1");return{6.4:"10",6.3:"8.1",6.2:"8",6.1:"7","6.0":"Vista",5.2:"XP",5.1:"XP","5.0":"2000"}[t]||t},Android:function(){return e.replace(/^.*Android ([\d.]+);.*$/,"$1")},iOS:function(){return e.replace(/^.*OS ([\d_]+) like.*$/,"$1").replace(/_/g,".")},Debian:function(){return e.replace(/^.*Debian\/([\d.]+).*$/,"$1")},"Windows Phone":function(){return e.replace(/^.*Windows Phone( OS)? ([\d.]+);.*$/,"$2")},"Mac OS":function(){return e.replace(/^.*Mac OS X ([\d_]+).*$/,"$1").replace(/_/g,".")},WebOS:function(){return e.replace(/^.*hpwOS\/([\d.]+);.*$/,"$1")}};i.osVersion="",c[i.os]&&(i.osVersion=c[i.os](),i.osVersion===e&&(i.osVersion=""));var d={Safari:function(){return e.replace(/^.*Version\/([\d.]+).*$/,"$1")},Chrome:function(){return e.replace(/^.*Chrome\/([\d.]+).*$/,"$1").replace(/^.*CriOS\/([\d.]+).*$/,"$1")},IE:function(){return e.replace(/^.*MSIE ([\d.]+).*$/,"$1").replace(/^.*rv:([\d.]+).*$/,"$1")},Edge:function(){return e.replace(/^.*Edge\/([\d.]+).*$/,"$1")},Firefox:function(){return e.replace(/^.*Firefox\/([\d.]+).*$/,"$1").replace(/^.*FxiOS\/([\d.]+).*$/,"$1")},"Firefox Focus":function(){return e.replace(/^.*Focus\/([\d.]+).*$/,"$1")},Chromium:function(){return e.replace(/^.*Chromium\/([\d.]+).*$/,"$1")},Opera:function(){return e.replace(/^.*Opera\/([\d.]+).*$/,"$1").replace(/^.*OPR\/([\d.]+).*$/,"$1")},Vivaldi:function(){return e.replace(/^.*Vivaldi\/([\d.]+).*$/,"$1")},Yandex:function(){return e.replace(/^.*YaBrowser\/([\d.]+).*$/,"$1")},Kindle:function(){return e.replace(/^.*Version\/([\d.]+).*$/,"$1")},Maxthon:function(){return e.replace(/^.*Maxthon\/([\d.]+).*$/,"$1")},QQBrowser:function(){return e.replace(/^.*QQBrowser\/([\d.]+).*$/,"$1")},QQ:function(){return e.replace(/^.*QQ\/([\d.]+).*$/,"$1")},Baidu:function(){return e.replace(/^.*BIDUBrowser[\s/]([\d.]+).*$/,"$1")},UC:function(){return e.replace(/^.*UC?Browser\/([\d.]+).*$/,"$1")},Sogou:function(){return e.replace(/^.*SE ([\d.X]+).*$/,"$1").replace(/^.*SogouMobileBrowser\/([\d.]+).*$/,"$1")},"2345Explorer":function(){return e.replace(/^.*2345Explorer\/([\d.]+).*$/,"$1")},TheWorld:function(){return e.replace(/^.*TheWorld ([\d.]+).*$/,"$1")},XiaoMi:function(){return e.replace(/^.*MiuiBrowser\/([\d.]+).*$/,"$1")},Quark:function(){return e.replace(/^.*Quark\/([\d.]+).*$/,"$1")},Qiyu:function(){return e.replace(/^.*Qiyu\/([\d.]+).*$/,"$1")},Wechat:function(){return e.replace(/^.*MicroMessenger\/([\d.]+).*$/,"$1")},Taobao:function(){return e.replace(/^.*AliApp\(TB\/([\d.]+).*$/,"$1")},Alipay:function(){return e.replace(/^.*AliApp\(AP\/([\d.]+).*$/,"$1")},Weibo:function(){return e.replace(/^.*weibo__([\d.]+).*$/,"$1")},Douban:function(){return e.replace(/^.*com.douban.frodo\/([\d.]+).*$/,"$1")},Suning:function(){return e.replace(/^.*SNEBUY-APP([\d.]+).*$/,"$1")},iQiYi:function(){return e.replace(/^.*IqiyiVersion\/([\d.]+).*$/,"$1")}};i.version="",d[i.browser]&&(i.version=d[i.browser](),i.version===e&&(i.version="")),i.version.indexOf(".")&&(i.version=i.version.substring(0,i.version.indexOf("."))),"Edge"===i.browser?i.engine="EdgeHTML":"Chrome"===i.browser&&parseInt(i.version)>27||"Opera"===i.browser&&parseInt(i.version)>12||"Yandex"===i.browser?i.engine="Blink":void 0===i.browser&&(i.browser="Unknow App")}function I(t){return new R(t)}class W extends E{constructor(t,i){super(t),e(this,"data"),e(this,"mainEl"),e(this,"bodyEl"),e(this,"contentEl"),e(this,"childrenEl"),e(this,"actionsEl"),e(this,"parent"),e(this,"nestedNum"),e(this,"maxNestingNum",3),e(this,"children",[]),e(this,"replyTo"),e(this,"afterRender"),e(this,"unread",!1),e(this,"openable",!1),e(this,"openURL"),e(this,"openEvt"),e(this,"onDelete"),this.data={...i},this.data.date=this.data.date.replace(/-/g,"/"),this.parent=null,this.nestedNum=1}renderElem(){this.el=n('<div class="atk-comment-wrap" data-comment-id="">\n  <div class="atk-comment">\n\n    <div class="atk-avatar">\n      <a target="_blank"><img src=""></a>\n    </div>\n\n    <div class="atk-comment-main">\n\n      <div class="atk-header">\n        <span class="atk-nick"><a target="_blank"></a></span>\n        <span class="atk-badge"></span>\n        <span class="atk-date"></span>\n        <span class="atk-ua ua-browser"></span>\n        <span class="atk-ua ua-os"></span>\n      </div>\n\n      <div class="atk-body">\n        <div class="atk-content"></div>\n      </div>\n\n      <div class="atk-footer">\n        <div class="atk-comment-actions"></div>\n      </div>\n\n    </div>\n\n  </div>\n</div>\n'),this.mainEl=this.el.querySelector(".atk-comment-main"),this.bodyEl=this.el.querySelector(".atk-body"),this.contentEl=this.bodyEl.querySelector(".atk-content"),this.actionsEl=this.el.querySelector(".atk-comment-actions"),this.childrenEl=null,this.unread?this.el.classList.add("atk-unread"):this.el.classList.remove("atk-unread"),this.openable?this.el.classList.add("atk-openable"):this.el.classList.remove("atk-openable"),this.el.addEventListener("click",(t=>{this.openable&&this.openURL&&(t.preventDefault(),window.open(this.openURL)),this.openEvt&&this.openEvt()})),this.el.setAttribute("data-comment-id",`${this.data.id}`),this.el.querySelector(".atk-avatar a").setAttribute("href",this.data.link),this.el.querySelector(".atk-avatar img").setAttribute("src",this.getGravatarUrl());const t=this.el.querySelector(".atk-nick > a");t.innerText=this.data.nick,t.href=this.data.link;const e=this.el.querySelector(".atk-badge");this.data.badge_name?(e.innerText=this.data.badge_name,this.data.badge_color&&(e.style.backgroundColor=this.data.badge_color)):e.remove();const i=this.el.querySelector(".atk-date");if(i.innerText=this.getDateFormatted(),i.setAttribute("data-atk-comment-date",String(+new Date(this.data.date))),this.el.querySelector(".atk-ua.ua-browser").innerText=this.getUserUaBrowser(),this.el.querySelector(".atk-ua.ua-os").innerText=this.getUserUaOS(),this.data.is_collapsed){this.contentEl.classList.add("atk-hide","atk-type-collapsed");const t=n('\n      <div class="atk-collapsed">\n        <span class="atk-text">该评论已被系统或管理员折叠</span>\n        <span class="atk-show-btn">查看内容</span>\n      </div>');this.bodyEl.insertAdjacentElement("beforeend",t);const e=t.querySelector(".atk-show-btn");e.addEventListener("click",(t=>{this.contentEl.classList.contains("atk-hide")?(this.contentEl.innerHTML=this.getContentMarked(),this.contentEl.classList.remove("atk-hide"),v(this.contentEl),e.innerHTML="收起内容"):(this.contentEl.innerHTML="",this.contentEl.classList.add("atk-hide"),e.innerHTML="查看内容"),t.stopPropagation()}))}else this.contentEl.innerHTML=this.getContentMarked();if(this.replyTo){const t=n('\n      <div class="atk-reply-to">\n        <div class="atk-meta">回复 <span class="atk-nick"></span>:</div>\n        <div class="atk-content"></div>\n      </div>');t.querySelector(".atk-nick").innerText=`@${this.replyTo.nick}`,t.querySelector(".atk-content").innerHTML=d(this.ctx,this.replyTo.content),this.bodyEl.prepend(t)}if(this.data.is_pending){const t=n('<div class="atk-pending">审核中，仅本人可见。</div>');this.bodyEl.prepend(t)}return this.initActionBtn(),this.afterRender&&this.afterRender(),this.el}eachComment(t,e){0!==t.length&&t.every((i=>!1!==e(i,t)&&(this.eachComment(i.getChildren(),e),!0)))}refreshUI(){const t=this.el,e=this.renderElem();t.replaceWith(e),this.playFadeInAnim(),this.eachComment(this.children,(t=>{var e;null==(e=t.parent)||e.getChildrenEl().appendChild(t.renderElem()),t.playFadeInAnim()}))}initActionBtn(){const t=n("<span></span>"),e=n("<span></span>");this.actionsEl.append(t),this.actionsEl.append(e);const i=()=>{t.innerText=`赞同 (${this.data.vote_up||0})`,e.innerText=`反对 (${this.data.vote_down||0})`};if(i(),t.onclick=()=>{new T(this.ctx).vote(this.data.id,"comment_up").then((t=>{this.data.vote_up=t,i()})).catch((t=>{window.alert(`投票失败：${t.msg||String(t)}`)}))},e.onclick=()=>{new T(this.ctx).vote(this.data.id,"comment_down").then((t=>{this.data.vote_down=t,i()})).catch((t=>{window.alert(`投票失败：${t.msg||String(t)}`)}))},this.data.is_allow_reply){const t=n('<span data-atk-action="comment-reply">回复</span>');this.actionsEl.append(t),t.addEventListener("click",(t=>{this.ctx.dispatchEvent("editor-reply",this.data),t.stopPropagation()}))}const s=n(`<span atk-only-admin-show>${this.data.is_collapsed?"取消折叠":"折叠"}</span>`);this.actionsEl.append(s),s.addEventListener("click",(t=>{this.adminEdit("collapsed",s),t.stopPropagation()}));const a=n(`<span atk-only-admin-show>${this.data.is_pending?"待审":"已审"}</span>`);this.actionsEl.append(a),a.addEventListener("click",(t=>{this.adminEdit("pending",a),t.stopPropagation()}));const r=n("<span atk-only-admin-show>删除</span>");this.actionsEl.append(r),r.addEventListener("click",(t=>{this.adminDelete(r),t.stopPropagation()}))}getIsRoot(){return null===this.parent}getChildren(){return this.children}putChild(t){t.parent=this,t.nestedNum=this.nestedNum+1,this.children.push(t),this.getChildrenEl().appendChild(t.getEl()),t.playFadeInAnim()}getChildrenEl(){return null===this.childrenEl&&(this.nestedNum<this.maxNestingNum?(this.childrenEl=n('<div class="atk-comment-children"></div>'),this.mainEl.appendChild(this.childrenEl)):this.parent&&(this.childrenEl=this.parent.getChildrenEl())),this.childrenEl}getParent(){return this.parent}getEl(){return this.el}getData(){return this.data}getGravatarUrl(){var t;return`${(null==(t=this.ctx.conf.gravatar)?void 0:t.cdn)||""}${this.data.email_encrypted}?d=${encodeURIComponent(this.ctx.conf.defaultAvatar||"")}&s=80`}getContentMarked(){return d(this.ctx,this.data.content)}getDateFormatted(){return l(new Date(this.data.date))}getUserUaBrowser(){const t=I(this.data.ua);return`${t.browser} ${t.version}`}getUserUaOS(){const t=I(this.data.ua);return`${t.os} ${t.osVersion}`}playFadeInAnim(){v(this.el)}adminEdit(t,e){if(e.classList.contains("atk-in-process"))return;const i=e.innerText;e.classList.add("atk-in-process"),e.innerText="修改中...","collapsed"===t?this.data.is_collapsed=!this.data.is_collapsed:"pending"===t&&(this.data.is_pending=!this.data.is_pending),new T(this.ctx).commentEdit(this.data).then((t=>{e.classList.remove("atk-in-process"),this.data=t,this.refreshUI(),v(this.bodyEl),this.ctx.dispatchEvent("list-refresh-ui")})).catch((t=>{console.error(t),e.classList.add("atk-error"),e.innerText="修改失败",setTimeout((()=>{e.innerText=i,e.classList.remove("atk-error"),e.classList.remove("atk-in-process")}),2e3)}))}adminDelete(t){if(t.classList.contains("atk-in-process"))return;const e=Number(t.getAttribute("data-btn-clicked")||1);if(e<2){if(1===e){const i=t.innerText;t.innerText="确认删除",setTimeout((()=>{t.innerText=i,t.setAttribute("data-btn-clicked","")}),2e3),t.setAttribute("data-btn-clicked",String(e+1))}return}const i=t.innerText;t.classList.add("atk-in-process"),t.innerText="删除中...",new T(this.ctx).commentDel(this.data.id,this.data.site_name).then((()=>{t.innerText=i,t.classList.remove("atk-in-process"),this.onDelete&&this.onDelete(this)})).catch((e=>{console.error(e),t.classList.add("atk-error"),t.innerText="删除失败",setTimeout((()=>{t.innerText=i,t.classList.remove("atk-error"),t.classList.remove("atk-in-process")}),2e3)}))}setUnread(t){this.unread=t,this.unread?this.el.classList.add("atk-unread"):this.el.classList.remove("atk-unread")}setOpenURL(t){t||(this.openable=!1,this.el.classList.remove("atk-openable")),this.openable=!0,this.openURL=t,this.el.classList.add("atk-openable")}}class N extends E{constructor(t){super(t),e(this,"el"),e(this,"commentsWrapEl"),e(this,"comments",[]),e(this,"data"),e(this,"pageSize",15),e(this,"offset",0),e(this,"type"),e(this,"readMoreEl"),e(this,"readMoreLoadingEl"),e(this,"readMoreTextEl"),e(this,"noCommentText"),e(this,"renderComment"),e(this,"paramsEditor"),e(this,"onAfterLoad"),e(this,"isLoading",!1),e(this,"isFirstLoad",!0),e(this,"flatMode",!1),e(this,"unread",[]),e(this,"unreadHighlight",!1),this.el=n('\n    <div class="atk-list-lite">\n      <div class="atk-list-comments-wrap"></div>\n      <div class="atk-list-read-more" style="display: none;">\n        <div class="atk-loading-icon" style="display: none;"></div>\n        <span class="atk-text">查看更多</span>\n      </div>\n    </div>\n    '),this.commentsWrapEl=this.el.querySelector(".atk-list-comments-wrap"),this.pageSize=this.conf.readMore&&this.conf.readMore.pageSize||this.pageSize,this.readMoreEl=this.el.querySelector(".atk-list-read-more"),this.readMoreLoadingEl=this.readMoreEl.querySelector(".atk-loading-icon"),this.readMoreTextEl=this.readMoreEl.querySelector(".atk-text"),this.readMoreEl.addEventListener("click",(()=>{this.readMore()})),this.noCommentText=this.conf.noComment||"无评论",setInterval((()=>{this.el.querySelectorAll("[data-atk-comment-date]").forEach((t=>{const e=t.getAttribute("data-atk-comment-date");t.innerText=l(new Date(Number(e)))}))}),3e4),this.ctx.addEventListener("unread-update",(t=>this.updateUnread(t.notifies)))}async reqComments(t=0){0===t&&this.clearComments(),this.isLoading=!0,0===t?m(this.el):this.readMoreBtnSetLoading(!0);const e=()=>{this.isLoading=!1,0===t?u(this.el):this.readMoreBtnSetLoading(!1)};let i;try{i=await new T(this.ctx).get(t,this.type,this.paramsEditor)}catch(s){throw this.onError(s.msg||String(s)),s}finally{e()}this.offset=t;try{this.onLoad(i),this.onAfterLoad&&this.onAfterLoad(i)}catch(s){throw this.onError(String(s)),s}finally{e()}}onLoad(t){this.data=t,f(this.el,null),this.importComments(t.comments),this.hasMoreComments?this.showReadMoreBtn():this.hideReadMoreBtn(),this.isFirstLoad&&this.hasMoreComments&&this.initScrollBottomAutoLoad(),this.ctx.dispatchEvent("unread-update",{notifies:t.unread||[]}),this.isFirstLoad=!1}onError(t){if(t=String(t),console.error(t),this.isFirstLoad){const e=n(`<span>${t}，无法获取评论列表数据<br/></span>`),i=n('<span style="cursor:pointer;">点击重新获取</span>');i.onclick=()=>{this.reqComments(0)},e.appendChild(i);const s=n('<span atk-only-admin-show> | <span style="cursor:pointer;">打开控制台</span></span>');s.onclick=()=>{this.ctx.dispatchEvent("sidebar-show",{viewName:"admin"})},this.ctx.user.data.isAdmin||s.classList.add("atk-hide"),e.appendChild(s),f(this.el,e)}else this.readMoreBtnShowErr(`${t} 获取失败`)}createComment(t){const e=new W(this.ctx,t);return e.afterRender=()=>{this.renderComment&&this.renderComment(e)},e.onDelete=t=>{this.deleteComment(t),this.refreshUI()},e}importComments(t){const e=i=>{const s=t.filter((t=>t.rid===i.data.id));0!==s.length&&s.forEach((t=>{t.is_allow_reply=i.data.is_allow_reply;const s=this.createComment(t);s.renderElem(),i.putChild(s),e(s)}))};this.flatMode?t.forEach((e=>{e.is_collapsed&&(e.is_allow_reply=!1);const i=this.createComment(e);if(0!==e.rid){const s=t.find((t=>t.id===e.rid));s&&(i.replyTo=s)}i.renderElem(),this.comments.push(i),e.visible&&(this.commentsWrapEl.appendChild(i.getEl()),i.playFadeInAnim())})):t.filter((t=>0===t.rid)).forEach((t=>{t.is_collapsed&&(t.is_allow_reply=!1);const i=this.createComment(t);i.renderElem(),this.comments.push(i),this.commentsWrapEl.appendChild(i.getEl()),i.playFadeInAnim(),e(i)})),this.refreshUI()}insertComment(t){var e;const i=this.createComment(t);i.renderElem(),0!==t.rid?null==(e=this.findComment(t.rid))||e.putChild(i):(this.commentsWrapEl.prepend(i.getEl()),this.comments.unshift(i)),k(i.getEl()),i.playFadeInAnim(),this.data&&(this.data.total+=1),this.refreshUI()}refreshUI(){const t=this.comments.length<=0;let e=this.commentsWrapEl.querySelector(".atk-list-no-comment");t&&(e||(e=n('<div class="atk-list-no-comment"></div>'),this.commentsWrapEl.appendChild(e),e.innerHTML=this.noCommentText)),!t&&e&&e.remove(),this.ctx.dispatchEvent("check-admin-show-el")}getListCommentCount(){return this.data&&this.data.total?Number(this.data.total||"0"):0}get hasMoreComments(){return!!this.data&&this.data.total_parents>this.offset+this.pageSize}async readMore(){const t=this.offset+this.pageSize;await this.reqComments(t)}showReadMoreBtn(){this.readMoreEl.style.display=""}hideReadMoreBtn(){this.readMoreEl.style.display="none"}readMoreBtnSetLoading(t){this.readMoreLoadingEl.style.display=t?"":"none",this.readMoreTextEl.style.display=t?"none":""}readMoreBtnShowErr(t){this.readMoreBtnSetLoading(!1);const e=this.readMoreTextEl.innerText;this.readMoreTextEl.innerText=t,this.readMoreEl.classList.add("atk-err"),setTimeout((()=>{this.readMoreTextEl.innerText=e,this.readMoreEl.classList.remove("atk-err")}),2e3)}initScrollBottomAutoLoad(){this.conf.readMore&&this.conf.readMore.autoLoad&&document.addEventListener("scroll",(()=>{const t=this.el.querySelector(".atk-list-comments-wrap > .atk-comment-wrap:nth-last-child(3)");t&&this.hasMoreComments&&(this.isLoading||g(t)&&this.readMore())}))}eachComment(t,e){0!==t.length&&t.every((i=>!1!==e(i,t)&&(this.eachComment(i.getChildren(),e),!0)))}findComment(t,e){e||(e=this.comments);let i=null;return this.eachComment(e,(e=>e.data.id!==t||(i=e,!1))),i}getCommentCount(){let t=0;return this.eachComment(this.comments,(()=>{t++})),t}deleteComment(t){let e;if("number"==typeof t){if(e=this.findComment(t),!e)throw Error(`未找到评论 ${t}`)}else e=t;e.getEl().remove(),this.eachComment(this.comments,((t,i)=>t!==e||(i.splice(i.indexOf(t),1),!1)))}clearComments(){this.commentsWrapEl.innerHTML="",this.data=void 0,this.comments=[]}updateUnread(t){this.unread=t,this.unreadHighlight&&this.eachComment(this.comments,(t=>{const e=this.unread.find((e=>e.comment_id===t.data.id));e?(t.setUnread(!0),t.setOpenURL(e.read_link),t.openEvt=()=>{this.unread=this.unread.filter((e=>e.comment_id!==t.data.id)),this.ctx.dispatchEvent("unread-update",{notifies:this.unread})}):t.setUnread(!1)}))}}class j extends N{constructor(t){super(t),e(this,"closeCommentBtnEl"),e(this,"openSidebarBtnEl"),e(this,"openAdminPanelBtnEl"),e(this,"unreadBadgeEl");const i=n('<div class="atk-list">\n  <div class="atk-list-header">\n    <div class="atk-comment-count">\n      <span class="atk-comment-count-num">0</span>\n      条评论\n    </div>\n    <div class="atk-right-action">\n      <span data-action="admin-close-comment" class="atk-hide" atk-only-admin-show>关闭评论</span>\n      <span data-action="open-admin-panel" class="atk-hide atk-on" atk-only-admin-show>控制台</span>\n      <span data-action="open-sidebar" class="atk-hide atk-on">\n        <span class="atk-unread-badge" style="display: none;"></span>\n        通知中心\n      </span>\n    </div>\n  </div>\n  <div class="atk-list-body"></div>\n  <div class="atk-list-footer">\n    <div class="atk-copyright"></div>\n  </div>\n</div>\n');i.querySelector(".atk-list-body").append(this.el),this.el=i,this.initListActionBtn(),this.el.querySelector(".atk-copyright").innerHTML='Powered By <a href="https://artalk.js.org" target="_blank" title="Artalk v2.0.0">Artalk</a>',this.ctx.addEventListener("list-reload",(()=>this.reqComments(0))),this.ctx.addEventListener("list-clear",(()=>this.clearComments())),this.ctx.addEventListener("list-refresh-ui",(()=>this.refreshUI())),this.ctx.addEventListener("list-import",(t=>this.importComments(t))),this.ctx.addEventListener("list-insert",(t=>this.insertComment(t))),this.ctx.addEventListener("list-comment-del",(t=>this.deleteComment(t.id))),this.ctx.addEventListener("list-update-data",(t=>{t(this.data),this.refreshUI()})),this.ctx.addEventListener("unread-update",(t=>{var e;return this.showUnreadBadge((null==(e=t.notifies)?void 0:e.length)||0)}))}refreshUI(){super.refreshUI(),this.el.querySelector(".atk-comment-count-num").innerText=String(this.getListCommentCount()),this.ctx.user.data.nick&&this.ctx.user.data.email?this.openSidebarBtnEl.classList.remove("atk-hide"):this.openSidebarBtnEl.classList.add("atk-hide"),this.ctx.dispatchEvent("check-admin-show-el"),this.data&&this.data.page&&!0===this.data.page.admin_only?(this.ctx.dispatchEvent("editor-close-comment"),this.closeCommentBtnEl.innerHTML="打开评论"):(this.ctx.dispatchEvent("editor-open-comment"),this.closeCommentBtnEl.innerHTML="关闭评论")}onLoad(t){super.onLoad(t),this.checkGoToCommentByUrlHash()}async checkGoToCommentByUrlHash(){let t=Number(a("atk_comment"));if(!t){const e=window.location.hash.match(/#atk-comment-([0-9]+)/);if(!e||!e[1]||Number.isNaN(Number(e[1])))return;t=Number(e[1])}if(!t)return;const e=this.findComment(t);e||this.hasMoreComments&&await this.readMore(),e&&(k(e.getEl(),!1),setTimeout((()=>{e.getEl().classList.add("atk-flash-once");const t=a("atk_notify_key");t&&new T(this.ctx).markRead(t).then((()=>{this.unread=this.unread.filter((t=>t.comment_id!==e.data.id)),this.ctx.dispatchEvent("unread-update",{notifies:this.unread})}))}),800))}initListActionBtn(){this.openSidebarBtnEl=this.el.querySelector('[data-action="open-sidebar"]'),this.openSidebarBtnEl.addEventListener("click",(()=>{this.ctx.dispatchEvent("sidebar-show",{viewName:"message"})})),this.openAdminPanelBtnEl=this.el.querySelector('[data-action="open-admin-panel"]'),this.openAdminPanelBtnEl.addEventListener("click",(()=>{this.ctx.dispatchEvent("sidebar-show",{viewName:"admin"})})),this.closeCommentBtnEl=this.el.querySelector('[data-action="admin-close-comment"]'),this.closeCommentBtnEl.addEventListener("click",(()=>{this.data&&(this.data.page.admin_only=!this.data.page.admin_only,this.adminPageEditSave())})),this.unreadBadgeEl=this.el.querySelector(".atk-unread-badge")}adminPageEditSave(){this.data&&this.data.page&&(this.ctx.dispatchEvent("editor-show-loading"),new T(this.ctx).pageEdit(this.data.page).then((t=>{this.data&&(this.data.page={...t}),this.refreshUI()})).catch((t=>{this.ctx.dispatchEvent("editor-notify",{msg:`修改页面数据失败：${t.msg||String(t)}`,type:"e"})})).finally((()=>{this.ctx.dispatchEvent("editor-hide-loading")})))}showUnreadBadge(t){t>0?(this.unreadBadgeEl.innerText=`${Number(t||0)}`,this.unreadBadgeEl.style.display="block"):this.unreadBadgeEl.style.display="none"}}class D extends E{constructor(t){super(t),e(this,"name",""),e(this,"title",this.name),e(this,"actions",{}),e(this,"activeAction"),e(this,"adminOnly",!1),this.el=n('<div class="atk-sidebar-view"></div>')}init(){}switch(t){}}class F extends D{constructor(){super(...arguments),e(this,"name","message"),e(this,"title","通知中心"),e(this,"actions",{mentions:"提及",all:"全部",mine:"我的",pending:"待审"}),e(this,"activeAction",""),e(this,"list"),e(this,"type","mentions")}init(){this.list=Q(this.ctx),this.el.innerHTML="",this.el.append(this.list.el),this.activeAction=this.type,this.switch(this.type)}switch(t){this.list&&(this.type=t,this.list.type=t,this.list.isFirstLoad=!0,this.list.reqComments())}}function Q(t){const e=new N(t);return e.flatMode=!0,e.unreadHighlight=!0,e.noCommentText='<div class="atk-sidebar-no-content">无内容</div>',e.renderComment=t=>{t.setOpenURL(`${t.data.page_key}#atk-comment-${t.data.id}`)},e}class V extends D{constructor(t){super(t),e(this,"name","admin"),e(this,"title","控制台"),e(this,"actions",{comment:"评论",page:"页面",site:"站点",setting:"配置"}),e(this,"activeAction",""),e(this,"adminOnly",!0),e(this,"cListInstance"),this.el=n('<div class="atk-msg-center"></div>')}get cList(){return this.cListInstance||(this.cListInstance=Q(this.ctx)),this.cListInstance}init(){this.activeAction="comment",this.switch("comment")}switch(t){this.el.innerHTML="","comment"===t?this.initCommentList():"page"===t?this.initPageList():"site"===t?this.initSiteList():"setting"===t&&this.initSetting()}async initSiteFilterBar(t){const e=await new T(this.ctx).siteGet(),i=[{name:"__ATK_SITE_ALL",label:"全部站点"}];e&&e.forEach((t=>{i.push({name:t.name,label:t.name})}));return G(i,(e=>t(e)))}async initCommentList(){const t=n('<div class="atk-admin-comment-list"></div>');t.append(this.cList.el);const e=(t,e)=>{this.cList&&(this.cList.type=`admin_${t}`,this.cList.isFirstLoad=!0,this.cList.paramsEditor=t=>{t.site_name=e},this.cList.reqComments())};let i=!1;const s={typeName:"all",siteName:""},a=G([{name:"all",label:"全部"},{name:"pending",label:"待审"}],(t=>{i&&(s.typeName=t.name,e(s.typeName,s.siteName))}));t.prepend(a);const r=await this.initSiteFilterBar((t=>{s.siteName=t.name,e(s.typeName,s.siteName)}));t.prepend(r),i=!0,this.el.innerHTML="",this.el.append(t)}async initPageList(){const t=n('<div class="atk-admin-page-list"></div>'),e=n('<div class="atk-sidebar-list"></div>');t.append(e);const i=await this.initSiteFilterBar((t=>{this.reqPages(e,t.name)}));t.prepend(i),this.el.innerHTML="",this.el.append(t)}async reqPages(t,e){t.innerHTML="";const i=await new T(this.ctx).pageGet(e);i?i.forEach((i=>{const s=n('\n      <div class="atk-item">\n      <div class="atk-title"></div>\n      <div class="atk-sub"></div>\n      <div class="atk-actions">\n        <div class="atk-item" data-action="page-edit-title">修改标题</div>\n        <div class="atk-item" data-action="page-fetch">获取标题</div>\n        <div class="atk-item" data-action="page-edit-key">修改 KEY</div>\n        <div class="atk-item" data-action="page-admin-only"></div>\n        <div class="atk-item" data-action="page-del">删除</div>\n      </div>\n      </div>');t.append(s),s.setAttribute("data-page-id",String(i.id));const a=s.querySelector(".atk-title"),r=s.querySelector(".atk-sub");a.innerText=i.title||i.key,r.innerText=i.key,a.onclick=()=>{window.open(`${i.url}`)},r.onclick=()=>{window.open(`${i.url}`)};const o=s.querySelector('[data-action="page-admin-only"]'),l=()=>{o.innerText=i.admin_only?"仅管理员可评":"所有人可评"};l(),o.onclick=t=>{t.stopPropagation(),i.admin_only=!i.admin_only,new T(this.ctx).pageEdit(i).then((t=>{i=t,l()}))};s.querySelector('[data-action="page-edit-title"]').onclick=()=>{const s=window.prompt("修改标题：",i.title);null!==s&&(i.title=s,new T(this.ctx).pageEdit(i).then((()=>{this.reqPages(t,e)})).catch((t=>{window.alert(`修改失败：${t.msg||"未知错误"}`)})))};const c=s.querySelector('[data-action="page-fetch"]');c.onclick=()=>{const t=c.innerText;c.innerText="获取中...",new T(this.ctx).pageFetch(i.id).then((t=>{i=t,s.querySelector(".atk-title").innerText=t.title})).catch((t=>{window.alert(`获取失败：${t.msg||"未知错误"}`)})).finally((()=>{c.innerText=t}))};s.querySelector('[data-action="page-edit-key"]').onclick=()=>{const s=window.prompt("修改 Key：",i.key);null!==s&&(i.key=s,new T(this.ctx).pageEdit(i).then((()=>{this.reqPages(t,e)})).catch((t=>{window.alert(`修改失败：${t.msg||"未知错误"}`)})))};s.querySelector('[data-action="page-del"]').onclick=()=>{window.confirm(`确认删除页面 "${i.title||i.key}"？将会删除所有相关数据`)&&(()=>{new T(this.ctx).pageDel(i.key,i.site_name).then((t=>{t&&s.remove()}))})()}})):t.innerHTML='<div class="atk-sidebar-no-content">无内容</div>'}async initSiteList(){const t=n('<div class="atk-site-list"></div>'),e=n('\n    <div class="atk-sidebar-list">\n      <div class="atk-site-add atk-form-inline-wrap">\n        <input type="text" name="siteAdd_name" placeholder="Name..." />\n        <input type="text" name="siteAdd_urls" placeholder="URL..." />\n        <button name="siteAdd_submit">Add</button>\n      </div>\n    </div>\n    ');t.append(e);const i=e.querySelector('[name="siteAdd_name"]'),s=e.querySelector('[name="siteAdd_urls"]');e.querySelector('[name="siteAdd_submit"]').onclick=()=>{const t=i.value.trim(),e=s.value.trim();""!==t?new T(this.ctx).siteAdd(t,e).then((()=>{this.initSiteList()})).catch((t=>{window.alert(`创建失败：${t.msg||""}`)})):i.focus()};const a=await new T(this.ctx).siteGet();a?(a.forEach((t=>{const i=n('\n      <div class="atk-item">\n      <div class="atk-title"></div>\n      <div class="atk-sub"></div>\n      <div class="atk-actions">\n        <div class="atk-item" data-action="site-rename">重命名</div>\n        <div class="atk-item" data-action="site-edit-urls">修改 URL</div>\n        <div class="atk-item" data-action="site-del">删除</div>\n      </div>\n      </div>');e.append(i),i.setAttribute("data-site-id",String(t.id));const s=i.querySelector(".atk-title"),a=i.querySelector(".atk-sub");s.innerText=t.name||t.first_url,s.onclick=()=>{window.open(`${t.first_url}`)},t.urls&&t.urls.forEach((t=>{const e=n('<span style="margin-right: 10px;" />');e.innerText=t,e.onclick=()=>{window.open(`${t}`)},a.append(e)}));i.querySelector('[data-action="site-del"]').onclick=()=>{window.confirm(`确认删除站点 "${t.name||t.first_url}"？将会删除所有相关数据`)&&(()=>{new T(this.ctx).siteDel(t.id,!0).then((t=>{t&&i.remove()}))})()};i.querySelector('[data-action="site-edit-urls"]').onclick=()=>{const e=window.prompt("修改 URL (多个 URL 用逗号隔开):",t.urls_raw);null!==e&&new T(this.ctx).siteEdit(t.id,{name:t.name,urls:e}).then((()=>{this.initSiteList()})).catch((t=>{window.alert(`修改失败：${t.msg||"未知错误"}`)}))};i.querySelector('[data-action="site-rename"]').onclick=()=>{const e=window.prompt("编辑站点名称：",t.name);null!==e&&new T(this.ctx).siteEdit(t.id,{name:e,urls:t.urls_raw}).then((()=>{this.initSiteList()})).catch((t=>{window.alert(`修改失败：${t.msg||"未知错误"}`)}))}})),this.el.innerHTML="",this.el.append(t)):t.append(n('<div class="atk-sidebar-no-content">无内容</div>'))}initSetting(){const t=n('<div class="atk-admin-setting"></div>'),e=n('\n    <div class="atk-setting">\n    <div class="atk-group atk-importer atk-form-wrap">\n    <div class="atk-title">导入评论数据</div>\n    <input type="file" name="importer_dataFile" accept="text/plain,.json" />\n    <div class="atk-label">数据类型：</div>\n    <select name="importer_dataType">\n      <option value="artalk_v1">Artalk v1 (PHP 旧版)</option>\n    </select>\n    <div class="atk-label">目标站点名：</div>\n    <input type="text" name="importer_siteName" />\n    <button class="atk-btn" name="importer_submit">导入</button>\n    </div>\n    </div>');t.append(e);const i=e.querySelector('[name="importer_dataFile"]'),s=e.querySelector('[name="importer_siteName"]'),a=e.querySelector('[name="importer_dataType"]'),r=e.querySelector('[name="importer_submit"]'),o=r.innerText;r.onclick=()=>{const t=s.value.trim(),e=a.value.trim();if(!i.files||0===i.files.length)return void window.alert("请打开文件");if(""===e)return void window.alert("请选择数据类型");const n=new FileReader;n.onload=()=>{const i=String(n.result);i&&(r.innerText="请稍后...",new T(this.ctx).importer(i,e,t).then((()=>{window.alert("导入成功")})).catch((t=>{console.error(t),window.alert(`导入失败：${t.msg||"未知错误"}`)})).finally((()=>{r.innerText=o})))},n.readAsText(i.files[0])},this.el.innerHTML="",this.el.append(t)}}function G(t,e){const i=n('<div class="atk-filter-bar"></div>');return t.forEach((t=>{const s=n("<span></span>");i.append(s),s.innerText=t.label,s.addEventListener("click",(()=>{e(t),i.querySelectorAll(".atk-active").forEach((t=>t.classList.remove("atk-active"))),s.classList.add("atk-active")}))})),i.firstChild.click(),i}class K extends E{constructor(t){super(t),e(this,"el"),e(this,"layer"),e(this,"actionsEl"),e(this,"contentEl"),e(this,"titleWrapEl"),e(this,"view"),e(this,"action"),e(this,"isFirstShow",!0),e(this,"viewInstances",{}),e(this,"registerViews",[F,V]),this.el=n('<div class="atk-sidebar">\n  <div class="atk-sidebar-inner">\n    <div class="atk-sidebar-title-wrap"><span class="atk-title-item atk-active"></span></div>\n    <div class="atk-sidebar-close"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/><path d="M0 0h24v24H0z" fill="none"/></svg></div>\n    <div class="atk-sidebar-actions"></div>\n    <div class="atk-sidebar-content"></div>\n  </div>\n</div>\n'),this.contentEl=this.el.querySelector(".atk-sidebar-content"),this.titleWrapEl=this.el.querySelector(".atk-sidebar-title-wrap"),this.actionsEl=this.el.querySelector(".atk-sidebar-actions"),this.el.querySelector(".atk-sidebar-close").addEventListener("click",(()=>{this.hide()})),this.ctx.addEventListener("sidebar-show",(t=>this.show(null==t?void 0:t.viewName))),this.ctx.addEventListener("sidebar-hide",(()=>this.hide())),this.registerViews.forEach((t=>{const e=new t(this.ctx);this.viewInstances[e.name]=e,e.el.classList.add(`atk-sidebar-view-${e.name}`);const i=n(`\n      <span class="atk-title-item" data-name="${e.name}">${e.title}</span>\n      `);e.adminOnly&&(i.setAttribute("atk-only-admin-show",""),this.ctx.user.data.isAdmin||i.classList.add("atk-hide")),this.titleWrapEl.append(i),i.addEventListener("click",(()=>{this.switchView(e)}))}))}show(t){this.el.style.transform="",this.layer=b(this.ctx,"sidebar",this.el),this.layer.show(),this.contentEl.scrollTo(0,0),setTimeout((()=>{this.el.style.transform="translate(0, 0)"}),20),t&&this.switchViewByName(t),this.isFirstShow&&(t||this.switchViewByName("message"),this.isFirstShow=!1)}hide(){var t;this.el.style.transform="",null==(t=this.layer)||t.dispose()}switchViewByName(t){this.viewInstances[t]?this.switchView(this.viewInstances[t]):console.error(`未找到 view: ${t}`)}switchView(t){this.view=t;const e=this.titleWrapEl.querySelector(`[data-name=${t.name}]`);this.titleWrapEl.querySelector(".atk-active").innerText=t.title,this.titleWrapEl.querySelectorAll(".atk-title-item").forEach((t=>{t.classList.contains("atk-active")||(t.style.display="")})),e.style.display="none",t.init(),this.contentEl.innerHTML="",this.contentEl.append(t.el),this.actionsEl.innerHTML="",Object.entries(t.actions).forEach((([e,i])=>{const s=n(`<span class="atk-action-item">${i}</span>`);this.actionsEl.append(s),t.activeAction===e&&s.classList.add("atk-active"),s.addEventListener("click",(()=>{t.switch(e),t.activeAction=e,this.actionsEl.querySelectorAll(".atk-active").forEach((t=>{t.classList.remove("atk-active")})),s.classList.add("atk-active")}))}))}}const z={el:"",placeholder:"来啊，快活啊 ( ゜- ゜)",noComment:"快来成为第一个评论的人吧~",sendBtn:"发送评论",defaultAvatar:"mp",pageKey:"",server:"",site:"",emoticons:{"颜表情":{inputType:"emoticon",container:{Hi:"|´・ω・)ノ","开心":"ヾ(≧∇≦*)ゝ","星星眼":"(☆ω☆)","掀桌":"（╯‵□′）╯︵┴─┴","流口水":"￣﹃￣","捂脸":"(/ω＼)","给跪":"∠( ᐛ 」∠)＿","哈？":"(๑•̀ㅁ•́ฅ)","斜眼":"→_→","加油":"୧(๑•̀⌄•́๑)૭","有木有WiFi":"٩(ˊᗜˋ*)و","前方高能预警":"(ノ°ο°)ノ","纳尼":"(´இ皿இ｀)","吓死惹":"⌇●﹏●⌇","已阅留爪":"(ฅ´ω`ฅ)","去吧大师球":"(╯°A°)╯︵○○○","太萌惹":"φ(￣∇￣o)","咦咦咦":'ヾ(´･ ･｀｡)ノ"',"气呼呼":"( ง ᵒ̌皿ᵒ̌)ง⁼³₌₃","我受到了惊吓":"(ó﹏ò｡)","什么鬼":"Σ(っ °Д °;)っ","摸摸头":'( ,,´･ω･)ﾉ"(´っω･｀｡)',"无奈":"╮(╯▽╰)╭ ","脸红":"o(*////▽////*)q ","悲哀":"＞﹏＜","静静地看着你":'( ๑´•ω•) "(ㆆᴗㆆ)',"不要哇":"(｡•ˇ‸ˇ•｡)"}},Emoji:{inputType:"emoji",container:["😀","😃","😄","😁","😆","😅","😂","😊","😉","👀","😌","😍","😘","😋","😜","😝","😎","😏","😒","😟","😕","😖","😫","😩","😠","😲","😵","😳","😱","😨","😢","😭","😷","✋","✌️","👊","👋","👏","👍","👎","❤️","🎉","🚀"]},"滑稽":{inputType:"image",container:{"原味稽":"https://i.loli.net/2019/02/01/5c53d26b7ae13.png","还是算了":"https://i.loli.net/2020/04/30/riySFlu75fJdG4p.png","蓝纹稽":"https://i.loli.net/2020/04/30/jyh5IVzpqXsHuvU.jpg","随稽应变":"https://i.loli.net/2017/02/05/5896e6ec1d528.jpg","蠕动":"https://i.loli.net/2017/02/05/5896e9712a3c1.gif","束手无稽":"https://i.loli.net/2020/04/30/dF8sTOpgomj7qf5.jpg","微笑默叹以为妙绝":"https://i.loli.net/2019/02/01/5c53daa84f24a.png","喝嘤料":"https://i.loli.net/2019/02/01/5c53d63d8c6af.jpg","暗中观察":"https://i.loli.net/2019/02/01/5c53dd21a2e7b.jpg","高兴":"https://i.loli.net/2019/02/01/5c53d1b9e5f38.jpg","惊稽":"https://i.loli.net/2019/02/01/5c53d1e2ad89f.jpg","可这和我的帅有什么关系":"https://i.loli.net/2017/02/05/5896ece29a8e0.jpg","狱稽":"https://i.loli.net/2020/04/30/cUEQrVYGFiDjqhy.jpg","梆":"https://i.loli.net/2020/04/30/TlAGjm6IvJSMVpq.jpg","吃鱼摆摆":"https://i.loli.net/2017/02/05/5896ec2cb7f39.gif","跃跃欲试 3":"https://i.loli.net/2017/02/05/5896ece2ac5a2.gif","突然滑稽":"https://i.loli.net/2019/02/01/5c53cf2a457f1.jpg","扶墙怂":"https://i.loli.net/2017/02/05/5896ece2ab57a.jpg","阔以":"https://i.loli.net/2020/04/30/7EYyq1TcBKa3eQ2.jpg","不得行":"https://i.loli.net/2020/04/30/KoqBGauX7TEfeyn.jpg","少儿不宜":"https://i.loli.net/2020/04/30/nt2ZWRozUNjBxAK.jpg","稽日可期":"https://i.loli.net/2020/04/30/FmfYcoMJesi2Ddq.jpg","哎":"https://i.loli.net/2020/04/30/ps7PTIANgSErqnU.jpg","别看丢人":"https://i.loli.net/2019/02/01/5c53d4f89ea29.jpg","地稽 2":"https://i.loli.net/2019/02/01/5c53dbae85687.jpg","地稽":"https://i.loli.net/2020/04/30/BnTMX35EPxleVmA.jpg","老阔有点扣":"https://i.loli.net/2020/04/30/fhDXbA9T1zJPlKk.gif","啊哈哈":"https://i.loli.net/2019/02/01/5c53dc2947d84.jpg","无稽可奈":"https://i.loli.net/2020/04/30/UyxTzB2fS3LtH7Q.jpg","老实巴交":"https://i.loli.net/2020/04/30/7DgSoyqwtYBxchE.jpg","紧张":"https://i.loli.net/2017/02/05/5896e8a408253.jpg","摇摆稽":"https://i.loli.net/2019/02/01/5c53d1904dcb2.gif","又不是不能用":"https://i.loli.net/2019/02/01/5c53ce897ab55.jpg","一时滑稽":"https://i.loli.net/2019/02/01/5c53d5d28e22c.jpg","无法接受":"https://i.loli.net/2019/02/01/5c53cee8422fc.jpg","嘤雄豪稽":"https://i.loli.net/2020/04/30/sbtw6o7iKaM4Nmq.jpg","相视双稽":"https://i.loli.net/2019/02/01/5c53d5a093149.jpg","稽皮发麻":"https://i.loli.net/2017/02/05/5896ece2a019f.jpg","地稽 3":"https://i.loli.net/2019/02/01/5c53dbe510bcf.jpg","地稽委屈":"https://i.loli.net/2019/02/01/5c53d76e250da.jpg","地稽抚摸":"https://i.loli.net/2020/04/30/cavZ6nNzMPimLy7.gif","地稽捶打":"https://i.loli.net/2020/04/30/vFVPynXaHR5sitk.gif","绝望":"https://i.loli.net/2019/02/01/5c53dc0ba2303.jpg","气稽败坏":"https://i.loli.net/2019/02/01/5c53d216f3c60.jpg","当场去世":"https://i.loli.net/2020/04/30/sogxHMTFWbE2lrP.jpg","喝酒":"https://i.loli.net/2019/02/01/5c53d78c3f4a5.jpg","老衲摆摊算命":"https://i.loli.net/2017/02/05/5896ece29d8a5.gif","老哥，稳":"https://i.loli.net/2017/02/05/5896ece29ebb0.jpg","自闭稽":"https://i.loli.net/2019/02/01/5c53d6603ee24.jpg","无话可说":"https://i.loli.net/2019/02/01/5c53d6a77b7e4.jpg","跃跃欲试":"https://i.loli.net/2017/02/05/5896e9710dfd5.jpg","跃跃欲试 2":"https://i.loli.net/2019/02/01/5c53dcc057350.jpg","满脑子骚操作":"https://i.loli.net/2020/04/30/xJXcUtO2BryHAsa.gif","稽之舞":"https://i.loli.net/2019/02/01/5c53de1a4d14d.gif","将稽就稽":"https://i.loli.net/2020/04/30/KVwf8qCrZts6WOT.gif"}}},gravatar:{cdn:"https://sdn.geekzu.org/avatar/"},darkMode:!1};var Y=new class{constructor(t){e(this,"conf"),e(this,"ctx"),e(this,"el"),e(this,"contextID",(new Date).getTime()),e(this,"checker"),e(this,"editor"),e(this,"list"),e(this,"sidebar"),e(this,"comments",[]),console.log("\n %c Artalk v2.0.0 %c 一款简洁有趣的可拓展评论系统 \n\n%c> https://artalk.js.org\n> https://github.com/ArtalkJS/Artalk\n","color: #FFF; background: #1DAAFF; padding:5px 0;","color: #FFF; background: #656565; padding:5px 0;",""),this.conf={...z,...t},this.conf.server=this.conf.server.replace(/\/$/,""),this.conf.pageKey||(this.conf.pageKey=window.location.href.split("#")[0]);try{const t=document.querySelector(this.conf.el);if(null===t)throw Error(`Sorry, Target element "${this.conf.el}" was not found.`);this.el=t}catch(i){throw console.error(i),new Error("Artalk config `el` error")}this.ctx=new p(this.el,this.conf),this.el.classList.add("artalk"),this.el.setAttribute("atk-run-id",this.contextID.toString()),""!==this.el.innerHTML.trim()&&(this.el.innerHTML=""),this.initDarkMode(),this.checker=new q(this.ctx),this.editor=new U(this.ctx),this.list=new j(this.ctx),this.sidebar=new K(this.ctx),this.el.appendChild(this.editor.el),this.el.appendChild(this.list.el),this.el.appendChild(this.sidebar.el),this.list.reqComments(),window.addEventListener("hashchange",(()=>{this.list.checkGoToCommentByUrlHash()})),this.ctx.addEventListener("check-admin-show-el",(()=>{const t=[];this.el.querySelectorAll("[atk-only-admin-show]").forEach((e=>t.push(e)));const{wrapEl:e}=w(this.ctx);e&&e.querySelectorAll("[atk-only-admin-show]").forEach((e=>t.push(e))),t.forEach((t=>{this.ctx.user.data.isAdmin?t.classList.remove("atk-hide"):t.classList.add("atk-hide")}))})),this.ctx.addEventListener("user-changed",(()=>{this.ctx.dispatchEvent("check-admin-show-el"),this.ctx.dispatchEvent("list-refresh-ui")}))}initDarkMode(){this.conf.darkMode?this.el.classList.add(x):this.el.classList.remove(x);const{wrapEl:t}=w(this.ctx);t&&(this.conf.darkMode?t.classList.add(x):t.classList.remove(x))}setDarkMode(t){this.ctx.conf.darkMode=t,this.initDarkMode()}openDarkMode(){this.setDarkMode(!0)}closeDarkMode(){this.setDarkMode(!1)}}({el:"#comments",placeholder:"来啊，快活啊 ( ゜- ゜)",defaultAvatar:"mp",pageKey:"https://artalk.js.org/",pageTitle:"Artalk Home",server:"localhost"===location.hostname||"127.0.0.1"===location.hostname?"http://localhost:23366/api":"https://artalk.qwqaq.com/api",site:"ArtalkDemo",readMore:{pageSize:15,autoLoad:!0}});window.artalk=Y,function(){const t=document.querySelector(".to-top");function e(){const e=window.scrollY,i=window.screen.height,s=e>0&&e>i;t.style.display=s?"":"none"}t.addEventListener("click",(()=>{window.scrollTo(0,0)})),e(),document.addEventListener("scroll",(()=>{e()}))}(),function(){let t=!1;if("true"==(localStorage.getItem("dark_mode_on")||null))t=!0;else try{window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&(t=!0)}catch{}function e(){Y.setDarkMode(t),t?document.body.classList.add("dark-mode"):document.body.classList.remove("dark-mode")}e();document.querySelector(".to-night").addEventListener("click",(()=>{var i;t=!t,i=t,localStorage.setItem("dark_mode_on",String(i)),e()}));try{window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(i=>{const s=i.matches?"dark":"light";t="dark"==s,e()}))}catch{}}();
